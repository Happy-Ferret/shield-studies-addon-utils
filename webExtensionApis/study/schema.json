[
  {
    "namespace": "study",
    "description": "Interface for Shield and Pioneer studies.",
    "apiVersion": 5,
    "types": [
      {
        "id": "studySetup",
        "type": "object",
        "properties": {
          "activeExperimentName": {
            "type": "string"
          },
          "studyType": {
            "type": {
              "enum": ["shield", "pioneer"]
            }
          },
          "expire": {
            "type": "object",
            "properties": {
              "days": {
                "type": "integer"
              }
            }
          },
          "endings": {
            "type": "array"
          },
          "weightedVariations": {
            "type": "array"
          },
          "logLevel": {
            "type": "integer"
          },
          "telemetry": {
            "type": "object",
            "properties": {
              "send": {
                "type": "boolean"
              },
              "removeTestingFlag": {
                "type": "boolean"
              }
            }
          }
        },
        "required": [
          "activeExperimentName",
          "studyType",
          "expire",
          "endings",
          "weightedVariations",
          "logLevel",
          "telemetry"
        ],
        "additionalProperties": {
          "type": "any"
        }
      },
      {
        "id": "weightedVariations",
        "type": "array"
      },
      {
        "id": "anEnding",
        "type": "object",
        "additionalProperties": {
          "type": "any"
        }
      }
    ],
    "functions": [
      {
        "name": "setup",
        "type": "function",
        "async": true,
        "description":
          "Attempt an setup/enrollment, with these effects:\n\n- sets 'studyType' as Shield or Pioneer\n  - affects telemetry\n  - watches for dataPermission changes that should *always*\n    stop that kind of study\n\n- Use or choose variation\n  - `testing.variation` if present\n  - OR deterministicVariation\n    for the studyType using `weightedVariations`\n\n- During firstRun[1] only:\n  - set firstRunTimestamp pref value\n  - send 'enter' ping\n  - if `allowEnroll`, send 'install' ping\n  - else endStudy(\"ineligible\") and return\n\n- Every Run\n  - setActiveExperiment(studySetup)\n  - monitor shield | pioneer permission endings\n  - suggests alarming if `expire` is set.\n\nReturns:\n- info object (see `info`)\n\nTelemetry Sent\n\nFires Events\n\n(At most one of)\n- study:ready  OR\n- study:endStudy\n\nPrefs set\n- first run\n\nNote:\n1. first run is evaluated based on a pref  `shield.${id}.firstRunTimestamp`\n2. allowEnroll is ONLY used during first run (install)\n",
        "returns": "info",
        "parameters": [
          {
            "name": "studySetup",
            "$ref": "studySetup"
          }
        ]
      },
      {
        "name": "endStudy",
        "type": "function",
        "async": true,
        "defaultReturn": {
          "urls": ["url1", "url2"],
          "endingName": "some-reason"
        },
        "description":
          "Optionally opens url, then ends study with pings ending, exit.  Study can only have one ending.  Uninstalls addon?",
        "parameters": [
          {
            "name": "anEndingName",
            "type": ["string", "null"]
          },
          {
            "name": "anEndingObject",
            "type": "object",
            "optional": true
          }
        ],
        "returns": "directions for what to do next by the addon"
      },
      {
        "name": "info",
        "type": "function",
        "async": true,
        "description":
          "current study configuration, including\n- variation\n- activeExperimentName\n- timeUntilExpire\n- firstRunTimestamp\n\nBut not:\n- telemetry clientId\n\nThrows Error if called before `browser.study.setup`\n",
        "defaultReturn": {
          "variation": "styleA"
        },
        "parameters": []
      },
      {
        "name": "getDataPermissions",
        "type": "function",
        "async": true,
        "description":
          "object of current dataPermissions with keys shield, pioneer, telemetry, 'ok'",
        "defaultReturn": {
          "shield": true,
          "pioneer": false,
          "telemetry": true
        },
        "parameters": []
      },
      {
        "name": "sendTelemetry",
        "type": "function",
        "async": true,
        "parameters": [
          {
            "name": "payload",
            "type": "object"
          },
          {
            "name": "pingType",
            "type": "string"
          }
        ],
        "defaultReturn": "undefined",
        "returns": "Nothing"
      },
      {
        "name": "getSentTelemetry",
        "type": "function",
        "async": true,
        "description":
          "for isEligible, testing, and other uses, get recent stored Telemetry pings",
        "defaultReturn": [
          {
            "pingType": "main"
          }
        ],
        "returns": "Array of Telemetry pings",
        "parameters": [
          {
            "name": "telemetrySelectionOptions",
            "type": "any",
            "description": "`{ type, n, minTimestamp, headersOnly }`"
          }
        ]
      },
      {
        "name": "deterministicVariation",
        "type": "function",
        "async": true,
        "defaultReturn": "styleA",
        "returns": "Name of a variation from weightedVariations",
        "parameters": [
          {
            "name": "weightedVariations",
            "type": "object"
          },
          {
            "name": "algorithm",
            "type": "string"
          },
          {
            "name": "fraction",
            "type": "Number",
            "optional": true
          }
        ]
      },
      {
        "name": "surveyUrl",
        "type": "function",
        "async": true,
        "description":
          "Format url with study covariate queryArgs appended / mixed in.\n\nUse this for constructing midpoint surveys.\n",
        "defaultReturn": "https://example.com?version=59.0&branch=studyA",
        "parameters": [
          {
            "name": "baseUrl",
            "type": "string"
          },
          {
            "name": "additionalFields",
            "type": "object",
            "optional": true
          }
        ]
      },
      {
        "name": "validateJSON",
        "type": "function",
        "async": true,
        "defaultReturn": {
          "valid": true,
          "errors": []
        },
        "description":
          "Using AJV, do jsonschema validation of an object.  Can be used to validate your arguments, packets at client.",
        "returns": "a validation object - { bool valid, array errors }",
        "parameters": [
          {
            "name": "someJson",
            "type": "object"
          },
          {
            "name": "jsonschema",
            "type": "object",
            "descripton": "a valid jsonschema object"
          }
        ]
      }
    ],
    "events": [
      {
        "name": "onDataPermissionsChange",
        "type": "function",
        "defaultReturn": {
          "shield": true,
          "pioneer": false
        },
        "description":
          "Fires whenever any 'dataPermission' changes, with the new dataPermission object.  Allows watching for shield or pioneer revocation.",
        "parameters": [
          {
            "name": "updatedPermissions",
            "type": "object"
          }
        ]
      },
      {
        "name": "onReady",
        "type": "function",
        "defaultReturn": {
          "variation": "styleA",
          "firstRunTimestamp": 1523968204184
        },
        "description":
          "Fires when the study is 'ready' for the feature to startup.",
        "parameters": [
          {
            "name": "studyInfo",
            "type": "object"
          }
        ]
      },
      {
        "name": "onEndStudy",
        "type": "function",
        "defaultReturn": {
          "urls": [],
          "reason": "some-reason"
        },
        "description": "Listen for when the study wants to end",
        "parameters": [
          {
            "name": "endingSteps",
            "type": "object"
          }
        ]
      }
    ]
  }
]
